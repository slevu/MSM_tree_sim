---
title: "Run simulated epidemic history"
author: "Stephane"
date: "3/27/2017"
header-includes:
   - \usepackage{multirow, booktabs, threeparttable}
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Epidemic simulation
The goal is to replicate a simple transmission history in a population that is comparable to MSM in London.
The simulation is based on a system of ordinary differential equations which describe the dynamics of the number of infected hosts in different categories. The model allows to vary how individual characteristics (including transient status as age or stage of infection) influence transmission.
A single epidemic simulation is produced by the `R` script `model0.r`. 

 Additionally, genealogical trees were simulated conditioning on the epidemic history, and trees were matched to the real UK metadata data pertaining to times of sampling and clinical stage of infection. For some analyses, sequence data were also simulated conditioning on simulated genealogies. Clustering and source attribution approaches were applied to simulated data with known transmission risk profiles to evaluate the ability of different approaches to identify transmission risk factors and to correctly estimate transmission risk ratios. 

****
The natural history of infection is modeled with a system of ordinary differential equations that tracks infected individuals as they progress through EHI, three chronic stages of infection, and AIDS. Diagnosed and treated individuals progress through infection at a reduced rate. The model incorporates empirical death rates from natural and AIDS-related causes. The model closely reproduces empirical observations regarding the time from infection to AIDS (Text S2).
**** 
We also modeled importation of lineages into the DMA MSM risk group by adding an additional compartment that represents infected hosts outside of the DMA MSM risk group. DMA MSM emigrate out of the risk group at a constant per capita rate, and immigration rates balance emigration rates by design, such that prevalence is unchanged by migration dynamics.
****
 'Birth matrix' F(t): Number of transmissions from donor in each of 120 compartments to recipient in each comprtment over time
 'Migration matrix' G(t): Number of transition from each compartment to each compartment over time
### Parameter fitting

%2.3 Compartmental epidemic model
\subsection{Compartmental epidemic model}
The epidemic history in London MSM was modeled with a system of ordinary differential equations determining transmission and transition through 5 infection stages (early HIV infection , 3 chronic stages based on CD4 and AIDS), 4 age groups (based on quartiles of observed diagnosed individuals in UKDRDB) and 3 diagnosis states (undiagnosed, diagnosed untreated and diagnosed under treatment). Individuals were further stratified by an arbitrary binary risk characteristic influencing transmission. The population was thus structured in 120 states. Furthermore, we modeled importation of infections into London, which can have a dramatic effect on HIV genetic diversity. All code used to simulate epidemic histories and genealogical trees is available online \cite{volz_london_2016}.
%2.3.1 Model parameters
\subsubsection{Model parameters}
Mean time of progressions to CD4 stages and proportion in each CD4 category after seroconversion were obtained from Cori et al. \cite{cori_cd4+_2015}. Transmission was allowed to vary according to weights provided by risk category, treatment status and according to age assortativity. A proportion of 20\% of the population were deemed to be at high risk with a ten-fold increase in transmission than low risk counterparts. Relative to undiagnosed individuals, diagnosed and treated patients had a reduction in transmission by respectively a factor 2 and 20. An age assortativity parameter was introduced in the transmission matrix which caused transmission rates to decrease as a power law function of the difference in age. Age groups were based on quantiles of observed age distribution of MSM diagnosed with HIV in London \cite{public_health_england_hiv_2014} and transmission rates were independent of age. 
Two variations in this simulation were explored in terms of how transmission rate varies with age of infection in order to evaluate rates of false-positive identification of transmission risk factors. We let infection stage influence transmission rates with a ten-fold increase in probability of transmission in early HIV infection and a three-fold increase in AIDS stage (baseline scenario), or transmission was independent of infection stage (equal rates scenario).
Expressed mathematically, the total transmission rate of a patient with CD4 stage $i$, continuum of care status $j$, and generic risk factor $k$ is $\lambda_{ijk}(t) \propto  r_i r_j r_k$, 
where $r_.$  are risk ratios for each category. Individual transmission rates are normalised so that total incidence is given by $\iota(t)$  based on a previous study \cite{phillips_increased_2013} assuming that dynamics of new infections in MSM was the same at the country level and in London.  
Incidence and diagnosis rates were modeled as logistic functions of time and jointly calibrated to match the number of MSM living with diagnosed HIV in London in 2012 \cite{yin_hiv_2014}. Rates of treatment were modelled as zero before 1995 and then increase according to a logistic function with maximum 1 and steepness 0.5.

```{r read}
library(knitr)
read_chunk('model0.R')
```

Load packages
```{r libs, warning=FALSE, message=FALSE}
```

Source C functions
```{r source C}

```

Define input parameters
```{r parameters}
```
\input{tab.tex}

Note: incidence and diagnosis rate scaling factors are a priori. Now, there are fitted 
doi:10.1371/journal.pone.0055312.g002 (Fig 2.A)

every individuals start infection at EHI stage


prRecipMat:
  - prob that recipient get infection, conditionning on
	- prob of being risk level 1 (80%) vs risk level 2 (20%)
	- EHI stage (only those recipient get infection)
	- care status (only undiagnosed get infection)
       	- age assortativity (power of age class difference) 
  - intervenes in F matrix [ F(i,j) = incidence * w * prRecipMat(i,j), with w = beta_NH * beta_age * beta_care * beta_risk ]


prStageRecipMat:
  - Prob for EHI recipient to jump to next other CD4 stage
